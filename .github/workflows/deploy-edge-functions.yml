name: Deploy Edge Functions (Auto)

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
      - 'supabase/config.toml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Detect changed functions
        id: changed-functions
        run: |
          # Get list of changed function directories
          CHANGED_FUNCTIONS=$(git diff --name-only HEAD~1 HEAD | grep '^supabase/functions/' | cut -d'/' -f3 | sort -u | tr '\n' ' ')
          
          if [ -z "$CHANGED_FUNCTIONS" ]; then
            echo "No function changes detected"
            echo "functions=" >> $GITHUB_OUTPUT
          else
            echo "Changed functions: $CHANGED_FUNCTIONS"
            echo "functions=$CHANGED_FUNCTIONS" >> $GITHUB_OUTPUT
          fi

      - name: Deploy changed functions
        if: steps.changed-functions.outputs.functions != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          # Link to project
          supabase link --project-ref $PROJECT_ID
          
          # Deploy each changed function
          for func in ${{ steps.changed-functions.outputs.functions }}; do
            if [ -d "supabase/functions/$func" ]; then
              echo "🚀 Deploying function: $func"
              
              if supabase functions deploy $func --project-ref $PROJECT_ID; then
                echo "✅ Successfully deployed: $func"
              else
                echo "❌ Failed to deploy: $func"
                exit 1
              fi
            else
              echo "⚠️ Function directory not found: $func"
            fi
          done
          
          echo "🎉 All functions deployed successfully!"

      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary 🚀" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Functions:** ${{ steps.changed-functions.outputs.functions }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
